
    /**
     * @lessonnine/marketing-tracker v3.14.0
     * (c) 2025 Lesson Nine GmbH
     * Released: 2025-06-24
     */
  
(function(c,d){typeof exports=="object"&&typeof module<"u"?module.exports=d():typeof define=="function"&&define.amd?define(d):(c=typeof globalThis<"u"?globalThis:c||self,c.MarketingTracker=d())})(this,function(){"use strict";const c=e=>e.toISOString().split("T")[0],d=e=>!isNaN(e.valueOf())&&e>=new Date(2015,0,1),p=e=>{const t=e instanceof Date?e:new Date(e);return d(t)?c(t):void 0},w=e=>{const t=new Date(e);if(isNaN(t.getTime()))throw new Error(`"${e}" is not a valid date`);return t},G=e=>new Promise((t,n)=>{const o=new XMLHttpRequest;o.open("GET",e),o.send(null),o.onload=()=>{o.readyState===XMLHttpRequest.DONE&&(o.status===200?t(o.responseText):n(new Error(`XHR request returned ${o.status}`)))},o.timeout=2e3,o.ontimeout=()=>{n(new Error(`XHR request timeout: ${e}`))},o.onerror=r=>{n(new Error(`XHR request error: ${r}`))}}),F="https://api.babbel.io/gamma/v1.0.0/en/geoip/me",q=()=>G(F).then(e=>JSON.parse(e)).then(e=>e.geoip),B=e=>e.match(/@/)!=null,V=e=>(e.match(/\?.*signin=/)||e.match(/\?.*auth_token=/))!=null,K=e=>{const t=new URL(e),n=[];for(const[o,r]of t.searchParams)n.push(`${o}=${r}`);return`${t.origin}${t.pathname}?${n.join("&")}${t.hash}`},x=e=>{const t=K(e);return B(t)||V(t)},u=()=>x(window.location.href),y=()=>new Promise(e=>{document.readyState==="complete"||document.readyState==="interactive"?e():document.addEventListener("DOMContentLoaded",()=>e())}),m=()=>window.location.host,H="gtm.js",_="gtm-script",i="GTM-5R6G5BT",X="GTM-MDD3PT",J="https://www.googletagmanager.com/gtm.js?id=",Q=[{id:i,hostPattern:/babbelforbusiness\.com/i},{id:i,hostPattern:/babbelfuerunternehmen\.de/i},{id:i,hostPattern:/babbel-for-business\.(preview|site)\.strattic\.io/i},{id:i,hostPattern:/babbel-b2b\.(preview|site)\.strattic\.io/i},{id:i,hostPattern:/babbel-b2b-eng\.(preview|site)\.strattic\.io/i},{id:i,hostPattern:/business\.babbel\.com/i}],W=e=>{const t=Q.find(n=>new RegExp(n.hostPattern).test(e));return t?t.id:X},Y=e=>{const t=document.createElement("script");return t.id=_,t.src=J+e,t.async=!0,t},z=async()=>{if(u()||document.getElementById(_))return;window.dataLayer=window.dataLayer||[],window.dataLayer.push({event:H,"gtm.start":new Date().getTime()});const e=Y(W(m()));await y(),document.body.appendChild(e)},Z=[{id:"production",hostPattern:/babbel\.com$/i},{id:"production",hostPattern:/babbelfuerunternehmen\.de$/i},{id:"production",hostPattern:/business\.babbel\.com$/i},{id:"staging",hostPattern:/babbel\.cn$/i},{id:"staging",hostPattern:/babbel-for-business\.(preview|site)\.strattic\.io$/i},{id:"staging",hostPattern:/babbel-b2b\.(preview|site)\.strattic\.io$/i},{id:"staging",hostPattern:/babbel-b2b-eng\.(preview|site)\.strattic\.io$/i},{id:"development",hostPattern:/localhost(:[0-9]+)?$/i},{id:"development",hostPattern:/localtest\.me/i}],ee="development",te=()=>{const e=Z.find(t=>new RegExp(t.hostPattern).test(m()));return e?e.id:ee},f=(e=document.cookie)=>{const t=e.split(";"),n={};return t.forEach(o=>{const[r,...a]=o.split("=");r!==""&&(n[r.trim()]=a.join("="))}),n},v=(e=f())=>e?.OptanonConsent,k=(e=v())=>e?e.split("&").map(n=>decodeURIComponent(n)).reduce((n,o)=>{const[r,...a]=o.split("=");return n[r.trim()]=a.join("="),n},{}):{},E=(e=f())=>e?._fbp,ne=(e=E())=>{if(!e)return{};const t=e.split(".")[2];return{value:e,...t&&{createdAt:new Date(Number(t))}}},oe=(e=f())=>e?.babbeltrackinguuid;function re(e){if(typeof e!="object"||e===null)throw new Error("Event data must be an object");const{name:t,version:n,...o}=e;if(typeof t!="string"||t.trim()==="")throw new Error("Event name must be a non-empty string");const r=g(o);return{name:t,version:n,...r||{}}}function g(e){if(e!=null){if(ae(e))return e;if(Array.isArray(e)){const t=e.map(g).filter(n=>n!==void 0);return t.length>0?t:void 0}if(typeof e=="object"){const t=Object.fromEntries(Object.entries(e).map(([n,o])=>[n,g(o)]).filter(([,n])=>n!==void 0));return Object.keys(t).length>0?t:void 0}}}function ae(e){return typeof e=="number"&&!isNaN(e)||typeof e=="string"&&e.trim()!==""||typeof e=="boolean"}const se={production:"https://api.babbel.io/gamma/v1/events",staging:"https://api.babbel-staging.io/gamma/v1/events",development:"/gamma/v1/events"}[te()],T=(e,t=se)=>{const{name:n,version:o,payload:r}=re(e),a={name:n,version:o,...r,tracking_uuid:r?.tracking_uuid||oe(),created_at:r?.created_at||new Date().toISOString(),...r?.uuid&&{uuid:r.uuid}};return fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:[a]}),keepalive:!0})},ie=[/Android/i,/webOS/i,/iPhone/i,/iPad/i,/iPod/i,/BlackBerry/i,/Windows Phone/i],ce=(e=window.navigator.userAgent)=>ie.some(t=>e.match(t));function de(e){return new Promise(t=>setTimeout(t,e))}async function ue(e,t,n){const o=Date.now();let r=e();for(;!r&&Date.now()-o<t;)await de(n),r=e();return r}const C={},h=(()=>{try{const e="t";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch{return!1}})(),S=e=>{const t=h?localStorage.getItem(e):C[e];return t?h?JSON.parse(t):t:null},P=(e,t)=>{h?localStorage.setItem(e,JSON.stringify(t)):C[e]=t},le=5e3,pe=200,O="lastSentFbpCookieEvent",me=60*60*1e3;async function fe(e,t,n=le,o=pe){if(!t.targeting_cookies)return;const r=await ue(E,n,o);if(!r)return;const a=ne(r),s=ge(e,a),l=S(O);l&&!he(s,l)||(T(s),P(O,s))}function ge(e,t){const{value:n,createdAt:o}=t;return{name:"partner_cookie:updated",version:1,payload:{created_at:new Date().toISOString(),uuid:e.uuid,type:e.uuid?"babbel_user":"visitor",marketing_tracker_version:"3.14.0",cookie:{type:"fbp",value:n,...o&&{created_at:o.toISOString()}}}}}function he(e,t,n=me){try{const o=w(e.payload.created_at).getTime(),r=w(t.payload.created_at).getTime();if(o-r<n&&e.payload.cookie.value===t.payload.cookie.value&&e.payload.type===t.payload.type&&e.payload.uuid===t.payload.uuid&&e.version===t.version)return!1}catch(o){return console.error("Error while comparing fbp cookie info:",o),!0}return!0}const L="user-consent",be=()=>S(L)||{preferences:null,uuid:null,consentProviderReady:!1},we=(e,t=null,n=!0)=>P(L,{preferences:e,uuid:t,consentProviderReady:n}),ye=(e={},t=null,n=!0)=>{const{preferences:o={},uuid:r,consentProviderReady:a}=be();return t!==r||o===null||e===null||a!==n?!0:Object.keys(e).some(s=>e[s]!==o[s])},_e=(e={},t=null,n=!0)=>{const o=ye(e,t,n);return we(e,t,n),o},ve="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js",ke=[{id:"76f8f301-1d03-46f3-a2dd-342d801d1864",host:/babbel\.com/i},{id:"4c3434b9-22f2-44cd-8343-aaf318112c3b",host:/babbel\.cn/i},{id:"019330c7-cb0b-78d7-b4ac-a1b835d4947b",host:/localtest\.me/i}],Ee=()=>ke.find(e=>m().match(e.host)!==null)?.id,R=[{name:"necessary_cookies",default:!0,code:"C0001"},{name:"performance_cookies",default:!1,code:"C0002"},{name:"functional_cookies",default:!1,code:"C0003"},{name:"targeting_cookies",default:!1,code:"C0004"}],Te=()=>R.reduce((e,{name:t,default:n})=>(e[t]=n,e),{}),I=()=>{const e=Te(),t=D();return t&&t.forEach(n=>{const[o,r]=n.split(":"),a=R.find(s=>s.code===o);a&&(e[a.name]=r==="1")}),e},D=(e=k())=>{try{const n=new URLSearchParams(e).get("groups");return n?n.split(","):void 0}catch(t){console.error("Error while parsing consent cookie:",t)}},Ce=()=>{if(!window.OneTrust)return{};const e=window.OneTrust.getGeolocationData();return{country:e.country,state_name:e.state}},Se=e=>{const t=Le(),n=I(),o=t;_e(n,e.uuid,o)&&T({name:"user_cookie_consent:updated",version:3,payload:{created_at:new Date().toISOString(),uuid:e.uuid,platform:ce()?"mobile":"web",type:e.uuid?"babbel_user":"visitor",consent_cookie_raw:t?v():void 0,consent_cookie:t?k():void 0,consent_preferences:n,marketing_tracker_version:"3.14.0",consent_provider_used:t,consent_provider_location:Ce()}})},Pe=e=>{const t=document.createElement("script");return t.src=ve,t.async=!0,t.type="text/javascript",t.dataset.domainScript=e,t.id="onetrust-script",t},Oe=async e=>{document.body.appendChild(e)},Le=()=>!!D(),A=e=>{Se(e),fe(e,I())},Re=e=>{A(e),window.OptanonWrapper=()=>{A(e)}},Ie=e=>{if(Re(e),!document.getElementById("onetrust-script")){const t=Ee();t&&Oe(Pe(t))}},De="marketingTracker.init",Ae=()=>{const e=document.querySelector('meta[name="marketing_content_group"]');return e?e.content:void 0},$e=async e=>{if(e.countryAlpha3){const{city:t,countryAlpha3:n,region:o}=e,r={country_alpha3:n,...t&&{city:t},...o&&{region:o}};window.dataLayer.push({event:"geoip.load",geo_data:r})}else try{const t=await q(),{city:n,country_code3:o,region:r}=t,a={country_alpha3:o,...n&&{city:n},...r&&{region:r}};window.dataLayer.push({event:"geoip.load",geo_data:a})}catch{window.dataLayer.push({event:"geoip.load",geo_data:{}})}},Ue=({geoData:e={},locale:t,learnLanguageAlpha3:n,userData:o={}})=>{if(u())return Promise.reject(new Error("Page is private so GTM will not be called from this page"));if(typeof window.dataLayer>"u")throw new Error("DataLayer not available. Try using the `load` method first.");return Ie(o),window.dataLayer.push({event:De,marketing_content_group:Ae(),lead_country_alpha3:o.leadCountryAlpha3,lead_date:p(o.leadDate),learn_language_alpha3:o.learnLanguageAlpha3||n,locale:t,uuid:o.uuid}),$e(e)},Ne=({countryAlpha3:e,email:t,eventName:n,leadDate:o,learnLanguageAlpha3:r,uuid:a})=>{if(!n)throw new Error('"eventName" field is required when building event objects');const s={event:n,lead_date:p(o),learn_language_alpha3:r,uuid:a};return t&&e==="USA"&&(s.email=t),s},$=e=>({uuid:t,leadDate:n,learnLanguageAlpha3:o,countryAlpha3:r,email:a})=>{if(u())return;if(!window.dataLayer)throw new Error("DataLayer not available.");const s=Ne({countryAlpha3:r,email:a,eventName:e,leadDate:n,learnLanguageAlpha3:o,uuid:t});window.dataLayer.push(s)},U={init:Ue,load:z,trackQuestionAnswered:({question:e,answer:t})=>{if(!u()){if(!window.dataLayer)throw new Error("DataLayer not available.");window.dataLayer.push({event:"question:answered",payload:{question:e,answer:t}})}},trackSalesConversion:({id:e,couponCode:t,price:n,netAmount:o,taxAmount:r,currency:a,subscriptionKeyCode:s,skuKeyCode:l,productTitle:Ve},{uuid:Ke,leadDate:xe,learnLanguageAlpha3:He})=>{if(!u()){if(!window.dataLayer)throw new Error("DataLayer not available.");window.dataLayer.push({event:"purchase_completed",lead_date:p(xe),learn_language_alpha3:He,uuid:Ke,purchase:{purchase_id:e,coupon_code:t,price:n,currency:a,subscription_mode_key_code:s},ecommerce:{currencyCode:a,purchase:{actionField:{id:e,revenue:n,tax:r,coupon:t},products:[{id:l,name:Ve,price:o,quantity:1}]}}})}},trackSimpleLead:$("registration_completed"),trackVerifiedLead:$("email_verified")},N=e=>Object.keys(e).filter(t=>e[t]!==void 0).map(t=>t+"="+encodeURIComponent(e[t])).join("&"),Me=e=>{const t={};return new URL(e).searchParams.forEach((o,r)=>t[r]=o),t},b=e=>new Image().src=e,je=e=>{const t=N(e);return t.length===0?"":`?${t}`},Ge=async()=>{const e="ads-container",t=document.createElement("div");t.id=e,t.style="display:none",await y(),document.body.appendChild(t)},Fe=()=>window.location.href,qe=()=>{const e=document.querySelector('meta[name="marketing_content_group"]');return e?e.content:""},Be=()=>{const e=document.querySelector('meta[name="product_category"]');return e?e.content:""},M=()=>N({dr:document.referrer,pt:qe(),dl:window.location.href,pc:Be(),v:"3.14.0"});class j{constructor(t){if(t&&t.host)this.host=t.host.replace(/\/$/,"");else throw new Error("Host should be set.");Ge()}getConversionURL(t,n,o={}){const r=je(o);return`${this.host}/accounts/${t}/conversions/${n}.js${r}`}trackUserClick(){const t="click",{bsc:n,btp:o}=Me(Fe());let r=!1;const a=()=>{if(!r){r=!0,document.removeEventListener(t,a);const s=`${this.host}/${n}/${o}/clicked.gif?${M()}`;b(s)}};n&&o&&document.addEventListener(t,a)}trackSimpleLead(t){this.trackLead("simple_lead",t)}trackPageview(t){const n=`${this.host}/${t}/default.gif?${M()}`;b(n)}trackVerifiedLead(t){this.trackLead("verified_lead",t)}trackSalesConversion(t,{purchase_id:n,price:o,currency:r}){this.trackLead("purchase_finished",t,{purchase_id:n,price:o,currency:r})}trackLead(t,n,o){if(!n)throw new Error("UUID should be set.");const r=this.getConversionURL(n,t,o);b(r)}}return window.MarketingTracker||(window.MarketingTracker={gtm:U,CampaignsTracker:j}),typeof window.initMarketingTracker=="function"&&window.initMarketingTracker(),{gtm:U,CampaignsTracker:j}});
//# sourceMappingURL=index.js.map
